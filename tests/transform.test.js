const {
  _transform,
  _transformEnclosingPoleRing,
  transformRing,
  transformBbox,
  geojsonFromLinearRing,
  geojsonFromCornerCoordinates,
} = require("../dist/transform.js");

const {
  InvalidLinearRingError,
  EnclosingBothPolesError,
  InvalidBoundsError,
  NotAllowedWarpBoundsError,
  NotAllowedCwLinearRingError,
  InvalidLinearRingEnclosingPoleError,
} = require("../dist/errors.js");

const { CRS_EPSG4326 } = require("../dist/constants.js");

const crsEpsg4326 = CRS_EPSG4326;
const crsEpsg3411 =
  "+proj=stere +lat_0=90 +lat_ts=70 +lon_0=-45 +k=1 +x_0=0 +y_0=0 +a=6378273 +b=6356889.449 +units=m +no_defs";
const crsEpsg3412 =
  "+proj=stere +lat_0=-90 +lat_ts=-70 +lon_0=0 +k=1 +x_0=0 +y_0=0 +a=6378273 +b=6356889.449 +units=m +no_defs";
const crcEpsg32645 = "+proj=utm +zone=45 +datum=WGS84 +units=m +no_defs";
const crsEpsg32660 = "+proj=utm +zone=60 +datum=WGS84 +units=m +no_defs";
const crsEpsg3031 =
  "+proj=stere +lat_0=-90 +lat_ts=-71 +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs ";
const crsEpsg3857 =
  "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs";

it("transform", () => {
  expect(
    _transform(
      [
        [-10, -10],
        [10, -10],
        [10, 10],
        [-10, 10],
        [-10, -10],
      ],
      crsEpsg4326,
      crsEpsg4326
    )
  ).toEqual([
    [-10, -10],
    [10, -10],
    [10, 10],
    [-10, 10],
    [-10, -10],
  ]);

  expect(_transform([[0, 89]], crsEpsg4326, crsEpsg3857)).toEqual([
    [0, 30240971.958386205],
  ]);

  expect(
    _transform(
      [
        [223069, -268407],
        [-275846, -495187],
      ],
      crsEpsg3411,
      crsEpsg4326
    )
  ).toEqual([
    [-5.270541933285495, 86.77915026771586],
    [-74.12017710269978, 84.77098843082935],
  ]);
});

it("transformEnclosingPoleRing", () => {
  expect(
    _transformEnclosingPoleRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [-1156379.742859589401633, -520081.609968872275203],
        [919322.002944564330392, -628513.79071983625181],
        [979561.568040528334677, 524643.59826003969647],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3411,
      0,
      true
    )
  ).toEqual([
    [-165.0085828152573, 78.3537208449233],
    [-110.78417499347036, 78.33427559463203],
    [10.640716221111093, 79.74628788579491],
    [73.17306663110055, 79.7684835157352],
    [180, 82.08068862192995],
    [180, 90],
    [-180, 90],
    [-180, 82.08068862192995],
    [-165.0085828152573, 78.3537208449233],
  ]);

  expect(
    _transformEnclosingPoleRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [-1156379.742859589401633, -520081.609968872275203],
        [919322.002944564330392, -628513.79071983625181],
        [979561.568040528334677, 524643.59826003969647],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3412,
      0,
      false
    )
  ).toEqual([
    [-59.9914171847427, -78.3537208449233],
    [-114.21582500652968, -78.33427559463203],
    [-180, -84.6451943499158],
    [-180, -90],
    [180, -90],
    [180, -84.6451943499158],
    [124.35928377888892, -79.74628788579491],
    [61.82693336889944, -79.7684835157352],
    [-59.9914171847427, -78.3537208449233],
  ]);

  expect(
    _transformEnclosingPoleRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [979561.568040528334677, 524643.59826003969647],
        [919322.002944564330392, -628513.79071983625181],
        [-1156379.742859589401633, -520081.609968872275203],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3411,
      0,
      true
    )
  ).toEqual([
    [-165.0085828152573, 78.3537208449233],
    [-180, 82.08068862192995],
    [-180, 90],
    [180, 90],
    [180, 82.08068862192995],
    [73.17306663110055, 79.7684835157352],
    [10.640716221111093, 79.74628788579491],
    [-110.78417499347036, 78.33427559463203],
    [-165.0085828152573, 78.3537208449233],
  ]);

  expect(
    _transformEnclosingPoleRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [979561.568040528334677, 524643.59826003969647],
        [919322.002944564330392, -628513.79071983625181],
        [-1156379.742859589401633, -520081.609968872275203],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3412,
      0,
      false
    )
  ).toEqual([
    [-59.9914171847427, -78.3537208449233],
    [61.82693336889944, -79.7684835157352],
    [124.35928377888892, -79.74628788579491],
    [180, -84.6451943499158],
    [180, -90],
    [-180, -90],
    [-180, -84.6451943499158],
    [-114.21582500652968, -78.33427559463203],
    [-59.9914171847427, -78.3537208449233],
  ]);

  expect(
    _transformEnclosingPoleRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [-1156379.742859589401633, -520081.609968872275203],
        [919322.002944564330392, -628513.79071983625181],
        [979561.568040528334677, 524643.59826003969647],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3411,
      5,
      true
    )
  ).toEqual([
    [-165.0085828152573, 78.3537208449233],
    [-156.7304154704545, 79.03978596130258],
    [-147.56016241240815, 79.47196311680196],
    [-137.87174675667896, 79.61767780469414],
    [-128.19004427118713, 79.46477183460594],
    [-119.03782920095917, 79.02598714163038],
    [-110.78417499347036, 78.33427559463203],
    [-101.41444194424898, 81.03727076699988],
    [-84.86374614619687, 83.31790529580597],
    [-56.66149298501777, 84.59073393509807],
    [-23.997303500485923, 84.14752952709192],
    [-1.7935794108101495, 82.28025812231864],
    [10.640716221111093, 79.74628788579491],
    [19.850678745270386, 80.5432073715608],
    [30.432438977673545, 81.05772172159838],
    [41.869003138215085, 81.23893808369635],
    [53.31663765063284, 81.06622091117508],
    [63.9269330905173, 80.55927219284123],
    [73.17306663110055, 79.7684835157352],
    [81.98152239048378, 81.75083902053998],
    [95.7940802367282, 83.42764891884764],
    [116.81087569236766, 84.50349273924773],
    [142.71035788751252, 84.60173769508268],
    [165.01742621551023, 83.67635700611854],
    [180, 82.08068862192995],
    [180, 90],
    [-180, 90],
    [-180, 82.08068862192995],
    [-176.604555128726, 81.50928142471932],
    [-173.6474814909233, 80.91238836229148],
    [-171.06209142427136, 80.29488780447296],
    [-168.79122851403028, 79.66065491509582],
    [-166.7867724748905, 79.01277578737971],
    [-165.0085828152573, 78.3537208449233],
  ]);
});

it("transformRing", () => {
  expect(
    transformRing(
      [
        [0, 0],
        [10000, 0],
        [10000, 10000],
        [0, 0],
      ],
      crsEpsg3857
    )
  ).toEqual([
    [0, 0],
    [0.08983152841195215, 0],
    [0.08983152841195215, 0.08983149160840151],
    [0, 0],
  ]);

  expect(
    transformRing(
      [
        [382200, 2512500],
        [382200, 2279400],
        [610500, 2279400],
        [610500, 2512500],
        [382200, 2512500],
      ],
      crcEpsg32645
    )
  ).toEqual([
    [85.85296718933643, 22.715665870841406],
    [85.86949772758247, 20.610041795245515],
    [88.06045501053289, 20.610485722030123],
    [88.07596179098903, 22.716159863683806],
    [85.85296718933643, 22.715665870841406],
  ]);

  expect(
    transformRing(
      [
        [382200, 2512500],
        [382200, 2279400],
        [610500, 2279400],
        [610500, 2512500],
        [382200, 2512500],
      ],
      "EPSG:32645"
    )
  ).toEqual([
    [85.85296718933643, 22.715665870841406],
    [85.86949772758247, 20.610041795245515],
    [88.06045501053289, 20.610485722030123],
    [88.07596179098903, 22.716159863683806],
    [85.85296718933643, 22.715665870841406],
  ]);

  expect(
    transformRing(
      [
        [508800.0, 7247400.0],
        [508800.0, 7001100.0],
        [753000.0, 7001100.0],
        [753000.0, 7247400.0],
        [508800.0, 7247400.0],
      ],
      crsEpsg32660
    )
  ).toEqual([
    [177.18908505580518, 65.34932256544839],
    [177.17456390562776, 63.13910500179646],
    [-177.99275205341496, 63.05068519969726],
    [-177.57860702499977, 65.25180997065199],
    [177.18908505580518, 65.34932256544839],
  ]);

  expect(
    transformRing(
      [
        [170, -10],
        [-170, -10],
        [-170, 10],
        [170, 10],
        [170, -10],
      ],
      crsEpsg4326
    )
  ).toEqual([
    [170, -10],
    [-170, -10],
    [-170, 10],
    [170, 10],
    [170, -10],
  ]);

  expect(
    transformRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [-1156379.742859589401633, -520081.609968872275203],
        [919322.002944564330392, -628513.79071983625181],
        [979561.568040528334677, 524643.59826003969647],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3411
    )
  ).toEqual([
    [-165.0085828152573, 78.3537208449233],
    [-110.78417499347036, 78.33427559463203],
    [10.640716221111093, 79.74628788579491],
    [73.17306663110055, 79.7684835157352],
    [180, 82.08068862192995],
    [180, 90],
    [-180, 90],
    [-180, 82.08068862192995],
    [-165.0085828152573, 78.3537208449233],
  ]);

  expect(
    transformRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [-1156379.742859589401633, -520081.609968872275203],
        [919322.002944564330392, -628513.79071983625181],
        [979561.568040528334677, 524643.59826003969647],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3412
    )
  ).toEqual([
    [-59.9914171847427, -78.3537208449233],
    [-114.21582500652968, -78.33427559463203],
    [-180, -84.6451943499158],
    [-180, -90],
    [180, -90],
    [180, -84.6451943499158],
    [124.35928377888892, -79.74628788579491],
    [61.82693336889944, -79.7684835157352],
    [-59.9914171847427, -78.3537208449233],
  ]);

  expect(
    transformRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [979561.568040528334677, 524643.59826003969647],
        [919322.002944564330392, -628513.79071983625181],
        [-1156379.742859589401633, -520081.609968872275203],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3411
    )
  ).toEqual([
    [-165.0085828152573, 78.3537208449233],
    [-180, 82.08068862192995],
    [-180, 90],
    [180, 90],
    [180, 82.08068862192995],
    [73.17306663110055, 79.7684835157352],
    [10.640716221111093, 79.74628788579491],
    [-110.78417499347036, 78.33427559463203],
    [-165.0085828152573, 78.3537208449233],
  ]);

  expect(
    transformRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [979561.568040528334677, 524643.59826003969647],
        [919322.002944564330392, -628513.79071983625181],
        [-1156379.742859589401633, -520081.609968872275203],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3412
    )
  ).toEqual([
    [-59.9914171847427, -78.3537208449233],
    [61.82693336889944, -79.7684835157352],
    [124.35928377888892, -79.74628788579491],
    [180, -84.6451943499158],
    [180, -90],
    [-180, -90],
    [-180, -84.6451943499158],
    [-114.21582500652968, -78.33427559463203],
    [-59.9914171847427, -78.3537208449233],
  ]);

  expect(
    transformRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [-1156379.742859589401633, -520081.609968872275203],
        [919322.002944564330392, -628513.79071983625181],
        [979561.568040528334677, 524643.59826003969647],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3411,
      {
        partition: 5,
      }
    )
  ).toEqual([
    [-165.0085828152573, 78.3537208449233],
    [-156.7304154704545, 79.03978596130258],
    [-147.56016241240815, 79.47196311680196],
    [-137.87174675667896, 79.61767780469414],
    [-128.19004427118713, 79.46477183460594],
    [-119.03782920095917, 79.02598714163038],
    [-110.78417499347036, 78.33427559463203],
    [-101.41444194424898, 81.03727076699988],
    [-84.86374614619687, 83.31790529580597],
    [-56.66149298501777, 84.59073393509807],
    [-23.997303500485923, 84.14752952709192],
    [-1.7935794108101495, 82.28025812231864],
    [10.640716221111093, 79.74628788579491],
    [19.850678745270386, 80.5432073715608],
    [30.432438977673545, 81.05772172159838],
    [41.869003138215085, 81.23893808369635],
    [53.31663765063284, 81.06622091117508],
    [63.9269330905173, 80.55927219284123],
    [73.17306663110055, 79.7684835157352],
    [81.98152239048378, 81.75083902053998],
    [95.7940802367282, 83.42764891884764],
    [116.81087569236766, 84.50349273924773],
    [142.71035788751252, 84.60173769508268],
    [165.01742621551023, 83.67635700611854],
    [180, 82.08068862192995],
    [180, 90],
    [-180, 90],
    [-180, 82.08068862192995],
    [-176.604555128726, 81.50928142471932],
    [-173.6474814909233, 80.91238836229148],
    [-171.06209142427136, 80.29488780447296],
    [-168.79122851403028, 79.66065491509582],
    [-166.7867724748905, 79.01277578737971],
    [-165.0085828152573, 78.3537208449233],
  ]);
});

it("transformBbox", () => {
  expect(
    transformBbox([382200, 2279400, 610500, 2512500], crcEpsg32645)
  ).toEqual([
    85.85296718933643,
    20.610041795245515,
    88.07596179098903,
    22.71977571380184,
  ]);

  expect(
    transformBbox([382200, 2279400, 610500, 2512500], "epsg:32645")
  ).toEqual([
    85.85296718933643,
    20.610041795245515,
    88.07596179098903,
    22.71977571380184,
  ]);

  expect(
    transformBbox([508800, 7001100, 753000, 7247400], crsEpsg32660)
  ).toEqual([
    177.17456390562776,
    63.05068519969726,
    -177.57860702499977,
    65.34932256544839,
  ]);

  expect(
    transformBbox([508800, 7001100, 753000, 7247400], crsEpsg32660, {
      expand: true,
    })
  ).toEqual([
    177.17456390562776,
    63.05068519969726,
    -177.57860702499977 + 360,
    65.34932256544839,
  ]);

  expect(
    transformBbox([382200, 2279400, 10, 610500, 2512500, 50], crcEpsg32645)
  ).toEqual([
    85.85296718933643,
    20.610041795245515,
    10,
    88.07596179098903,
    22.71977571380184,
    50,
  ]);

  expect(
    transformBbox([508800, 7001100, 5, 753000, 7247400, 10], crsEpsg32660)
  ).toEqual([
    177.17456390562776,
    63.05068519969726,
    5,
    -177.57860702499977,
    65.34932256544839,
    10,
  ]);
});

it("geojsonFromLinearRing", () => {
  expect(
    geojsonFromLinearRing(
      [
        [-10, -10],
        [10, -10],
        [10, 10],
        [-10, 10],
        [-10, -10],
      ],
      crsEpsg4326,
      {
        partition: 0,
      }
    )
  ).toEqual({
    type: "Feature",
    bbox: [-10, -10, 10, 10],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-10, -10],
          [10, -10],
          [10, 10],
          [-10, 10],
          [-10, -10],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [-10, -10],
        [10, -10],
        [10, 10],
        [-10, 10],
        [-10, -10],
      ],
      "EPSG:4326",
      {
        partition: 0,
      }
    )
  ).toEqual({
    type: "Feature",
    bbox: [-10, -10, 10, 10],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-10, -10],
          [10, -10],
          [10, 10],
          [-10, 10],
          [-10, -10],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [-10, -10],
        [10, -10],
        [10, 10],
        [-10, 10],
        [-10, -10],
      ],
      crsEpsg4326,
      {
        partition: 1,
      }
    )
  ).toEqual({
    type: "Feature",
    bbox: [-10, -10, 10, 10],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-10.0, -10],
          [0.0, -10],
          [10, -10.0],
          [10, 0.0],
          [10.0, 10],
          [0.0, 10],
          [-10, 10.0],
          [-10, 0.0],
          [-10, -10],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [223069.075613658875227, -268407.860357680357993],
        [-275846.995845806901343, -495187.89283925422933],
        [-163320.733313913689926, -742745.670409420854412],
        [335595.338145552086644, -515965.637927847041283],
        [223069.075613658875227, -268407.860357680357993],
      ],
      crsEpsg3411
    )
  ).toEqual({
    type: "Feature",
    bbox: [
      -74.12022112082042,
      82.98826228650147,
      -5.270622665103448,
      86.88878705473334,
    ],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-5.270622665103448, 86.77914371855618],
          [-14.250061369548213, 86.87412426312318],
          [-23.548864966957215, 86.88878705473334],
          [-32.693812151359616, 86.82201802001164],
          [-41.25560995422688, 86.67873416307306],
          [-48.9538596657912, 86.46825557920494],
          [-55.68003779057252, 86.20176494269847],
          [-61.45601993315672, 85.89017913245713],
          [-66.37532859434766, 85.54298702755824],
          [-70.55724119088521, 85.16790348854887],
          [-74.12022112082042, 84.77097678044598],
          [-71.97110864705208, 84.61841509935437],
          [-69.94331397518876, 84.45873464719025],
          [-68.0315123231705, 84.29253849885926],
          [-66.22993488762883, 84.12038499165931],
          [-64.5325844049517, 83.94278809292268],
          [-62.93340319357807, 83.76021880654855],
          [-61.42639995777989, 83.57310727610472],
          [-60.00574206724918, 83.38184531482337],
          [-58.665819773133734, 83.18678915779185],
          [-57.40128818663171, 82.98826228650147],
          [-53.951992624649165, 83.27843524136415],
          [-50.20571088005186, 83.54224084412589],
          [-46.15863801687481, 83.77628363534642],
          [-41.818277399785174, 83.97705623949825],
          [-37.20658593714978, 84.14110603045513],
          [-32.36219263801153, 84.2652552572159],
          [-27.340749255999818, 84.3468555174671],
          [-22.212645835564576, 84.38403943161795],
          [-17.05792785558349, 84.37592038404522],
          [-11.959143304085023, 84.32269393312409],
          [-11.56347384314647, 84.5702079431649],
          [-11.129970887643905, 84.81748727101969],
          [-10.652993182505446, 85.06448689529408],
          [-10.12573285508205, 85.31115283779752],
          [-9.539901649072773, 85.55741971247636],
          [-8.885311834454305, 85.80320743194677],
          [-8.149308950579606, 86.04841671801508],
          [-7.315992915614546, 86.29292288494149],
          [-6.365131918099119, 86.53656708154573],
          [-5.270622665103448, 86.77914371855618],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [508800.0, 7247400.0],
        [508800.0, 7001100.0],
        [753000.0, 7001100.0],
        [753000.0, 7247400.0],
        [508800.0, 7247400.0],
      ],
      crsEpsg32660,
      {
        partition: 1,
      }
    )
  ).toEqual({
    type: "Feature",
    bbox: [
      177.17456390562776,
      63.05068519969726,
      -177.57860702499977,
      65.34932256544839,
    ],
    properties: {},
    geometry: {
      type: "MultiPolygon",
      coordinates: [
        [
          [
            [180, 65.31807448056006],
            [179.81058927281356, 65.323257946911],
            [177.18908505580518, 65.34932256544839],
            [177.18150083071316, 64.24429821916638],
            [177.17456390562776, 63.13910500179646],
            [179.59505058865196, 63.11547654369982],
            [180, 63.104599649017885],
            [180, 65.31807448056006],
          ],
        ],
        [
          [
            [-180, 63.104599649017885],
            [-177.99275205341496, 63.05068519969726],
            [-177.79484203871405, 64.15151244109893],
            [-177.57860702499977, 65.25180997065199],
            [-180, 65.31807448056005],
            [-180, 63.104599649017885],
          ],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [508800.0, 7247400.0],
        [508800.0, 7001100.0],
        [753000.0, 7001100.0],
        [753000.0, 7247400.0],
        [508800.0, 7247400.0],
      ],
      crsEpsg32660,
      {
        expand: true,
        partition: 0,
      }
    )
  ).toEqual({
    type: "Feature",
    properties: {},
    bbox: [
      177.17456390562776,
      63.05068519969726,
      182.42139297500023,
      65.34932256544839,
    ],
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [177.18908505580518, 65.34932256544839],
          [177.17456390562776, 63.13910500179646],
          [182.00724794658504, 63.05068519969726],
          [182.42139297500023, 65.25180997065199],
          [177.18908505580518, 65.34932256544839],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [-1096140.177763625513762, 633075.779011003673077],
        [-1156379.742859589401633, -520081.609968872275203],
        [919322.002944564330392, -628513.79071983625181],
        [979561.568040528334677, 524643.59826003969647],
        [-1096140.177763625513762, 633075.779011003673077],
      ],
      crsEpsg3411
    )
  ).toEqual({
    type: "Feature",
    bbox: [-180, 78.33427559463203, 180, 90],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-165.0085828152573, 78.3537208449233],
          [-160.16257633289092, 78.79354203737189],
          [-154.9587553393619, 79.1477921839058],
          [-149.4505239873033, 79.40763936563793],
          [-143.71962085104556, 79.56585225108991],
          [-137.87174675667896, 79.61767780469414],
          [-132.02633398624678, 79.56149722705176],
          [-126.30251759028022, 79.3990639258762],
          [-120.80519213585278, 79.13524609227295],
          [-115.61499425828698, 78.77735749499072],
          [-110.78417499347036, 78.33427559463203],
          [-105.76995748778847, 79.9879902258213],
          [-98.83712340333808, 81.53951876209959],
          [-89.001004495121, 82.91704307002345],
          [-75.06009439368336, 83.9956955433942],
          [-56.66149298501777, 84.59073393509807],
          [-36.347637884119145, 84.54030092929469],
          [-18.541227008113996, 83.8603779500487],
          [-5.27855036748528, 82.72654315186088],
          [4.047988843760613, 81.31665977118496],
          [10.640716221111093, 79.74628788579491],
          [15.987193596542555, 80.25492820404068],
          [21.86777007572516, 80.67060549389979],
          [28.225172689959418, 80.9801678249897],
          [34.94694975542481, 81.17223212518766],
          [41.869003138215085, 81.23893808369635],
          [48.795144816278444, 81.17739785565821],
          [55.52850355953701, 80.99027866095044],
          [61.90319845998868, 80.68526374070333],
          [67.8045177372023, 80.27362770911927],
          [73.17306663110055, 79.7684835157352],
          [77.993527169147, 80.98362223759588],
          [84.26221004411822, 82.11760524847263],
          [92.50632376510468, 83.12838803973774],
          [103.28459714904484, 83.95232102075329],
          [116.81087569236766, 84.50349273924773],
          [132.2795365630752, 84.69542212768854],
          [147.70989392649372, 84.49020085552958],
          [161.14815412830322, 83.92819413209226],
          [171.83285287326655, 83.09658050775579],
          [180, 82.08068862192995],
          [180, 90],
          [-180, 90],
          [-180, 82.08068862192995],
          [-177.90608100358713, 81.7412150541957],
          [-175.9803407340642, 81.39176919612935],
          [-174.20716472655897, 81.0335557420731],
          [-172.57213643660785, 80.66762405098912],
          [-171.06209142427136, 80.29488780447296],
          [-169.66510152415304, 79.9161429711118],
          [-168.37041663110088, 79.53208383471922],
          [-167.16838314687377, 79.14331706509645],
          [-166.05035177554888, 78.75037393447013],
          [-165.0085828152573, 78.3537208449233],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [-3863378.14880046620965, -3403211.632381634786725],
        [-3863378.14880046620965, -8429757.395874712616205],
        [4071086.651424143463373, -8429757.395874712616205],
        [4071086.651424143463373, -3403211.632381634786725],
        [-3863378.14880046620965, -3403211.632381634786725],
      ],
      crsEpsg3031
    )
  ).toEqual({
    type: "Feature",
    properties: {},
    bbox: [
      129.89382721521977,
      -59.38390114093208,
      -131.37650663910156,
      -15.854026072268905,
    ],
    geometry: {
      type: "MultiPolygon",
      coordinates: [
        [
          [
            [180, -21.546696071299067],
            [179.2941541519072, -21.56961457024826],
            [173.92406204862127, -21.271459019050027],
            [168.6587287821537, -20.512995293321396],
            [163.58010374228212, -19.325243083949406],
            [158.75302996539278, -17.753837513210254],
            [154.22213680975648, -15.854026072268905],
            [152.8165311712136, -18.566238538668777],
            [151.26248874705988, -21.334957808356194],
            [149.53787861473512, -24.151328880009594],
            [147.6166927675248, -27.003868827977087],
            [145.4684442771048, -29.877930507356112],
            [143.0576011735199, -32.755068579393836],
            [140.34318880246022, -35.61230157652255],
            [137.2788031710233, -38.421279122347414],
            [133.81344657771206, -41.14739730241746],
            [129.89382721521977, -43.74897071200449],
            [136.07678899102834, -48.37276816384038],
            [143.87221212663923, -52.55894615168264],
            [153.58138601056504, -56.017779180076886],
            [165.2293785584238, -58.40125878948846],
            [178.25207338432907, -59.38390114093208],
            [180, -59.30719369837912],
            [180, -21.546696071299067],
          ],
        ],
        [
          [
            [-180, -59.30719369837912],
            [-168.5452576709626, -58.804504408516515],
            [-156.4535727131933, -56.76026264320489],
            [-146.22054089487025, -53.54814436609983],
            [-137.9473608055741, -49.521337215869536],
            [-131.37650663910156, -44.98838921218498],
            [-135.3133332063629, -42.28850309827596],
            [-138.7705091622105, -39.469324369884916],
            [-141.8096252888133, -36.57353439389099],
            [-144.48786143991478, -33.63609835982083],
            [-146.85604884693151, -30.685333525853096],
            [-148.95824158782133, -27.743959535010642],
            [-150.83206189079993, -24.83003907567931],
            [-152.50938155437166, -21.95778308372054],
            [-154.01710002643057, -19.138225061751],
            [-155.37789932081398, -16.379780542422463],
            [-159.989492238762, -18.19929646027807],
            [-164.88756977196093, -19.675310355898244],
            [-170.02211706459093, -20.754581591818333],
            [-175.32335989563597, -21.394847659061156],
            [-180, -21.546696071299067],
            [-180, -59.30719369837912],
          ],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [-3863378.14880046620965, -3403211.632381634786725],
        [-3863378.14880046620965, -8429757.395874712616205],
        [4071086.651424143463373, -8429757.395874712616205],
        [4071086.651424143463373, -3403211.632381634786725],
        [-3863378.14880046620965, -3403211.632381634786725],
      ],
      crsEpsg3031,
      {
        expand: true,
      }
    )
  ).toEqual({
    type: "Feature",
    properties: {},
    bbox: [
      129.89382721521977,
      -59.38390114093208,
      228.62349336089844,
      -15.854026072268905,
    ],
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [228.62349336089844, -44.98838921218498],
          [224.6866667936371, -42.28850309827596],
          [221.2294908377895, -39.469324369884916],
          [218.1903747111867, -36.57353439389099],
          [215.51213856008522, -33.63609835982083],
          [213.14395115306849, -30.685333525853096],
          [211.04175841217867, -27.743959535010642],
          [209.16793810920007, -24.83003907567931],
          [207.49061844562834, -21.95778308372054],
          [205.98289997356943, -19.138225061751],
          [204.62210067918602, -16.379780542422463],
          [200.010507761238, -18.19929646027807],
          [195.11243022803907, -19.675310355898244],
          [189.97788293540907, -20.754581591818333],
          [184.67664010436403, -21.394847659061156],
          [179.2941541519072, -21.56961457024826],
          [173.92406204862127, -21.271459019050027],
          [168.6587287821537, -20.512995293321396],
          [163.58010374228212, -19.325243083949406],
          [158.75302996539278, -17.753837513210254],
          [154.22213680975648, -15.854026072268905],
          [152.8165311712136, -18.566238538668777],
          [151.26248874705988, -21.334957808356194],
          [149.53787861473512, -24.151328880009594],
          [147.6166927675248, -27.003868827977087],
          [145.4684442771048, -29.877930507356112],
          [143.0576011735199, -32.755068579393836],
          [140.34318880246022, -35.61230157652255],
          [137.2788031710233, -38.421279122347414],
          [133.81344657771206, -41.14739730241746],
          [129.89382721521977, -43.74897071200449],
          [136.07678899102834, -48.37276816384038],
          [143.87221212663923, -52.55894615168264],
          [153.58138601056504, -56.017779180076886],
          [165.2293785584238, -58.40125878948846],
          [178.25207338432907, -59.38390114093208],
          [191.4547423290374, -58.804504408516515],
          [203.5464272868067, -56.76026264320489],
          [213.77945910512975, -53.54814436609983],
          [222.0526391944259, -49.521337215869536],
          [228.62349336089844, -44.98838921218498],
        ],
      ],
    },
  });

  expect(
    geojsonFromLinearRing(
      [
        [-10, -10],
        [10, -10],
        [10, 10],
        [-10, 10],
        [-10, -10],
      ],
      crsEpsg4326,
      {
        partition: 0,
        expand: true,
      }
    )
  ).toEqual({
    type: "Feature",
    bbox: [-10, -10, 10, 10],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-10, -10],
          [10, -10],
          [10, 10],
          [-10, 10],
          [-10, -10],
        ],
      ],
    },
  });
});

it("geojsonFromCornerCoordinates", () => {
  expect(
    geojsonFromCornerCoordinates(
      [223069.075613658875227, -268407.860357680357993],
      [-275846.995845806901343, -495187.89283925422933],
      [335595.338145552086644, -515965.637927847041283],
      [-163320.733313913689926, -742745.670409420854412],
      crsEpsg3411
    )
  ).toEqual({
    type: "Feature",
    bbox: [
      -74.12022112082042,
      82.98826228650147,
      -5.270622665103448,
      86.88878705473334,
    ],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-5.270622665103448, 86.77914371855618],
          [-14.250061369548213, 86.87412426312318],
          [-23.548864966957215, 86.88878705473334],
          [-32.693812151359616, 86.82201802001164],
          [-41.25560995422688, 86.67873416307306],
          [-48.9538596657912, 86.46825557920494],
          [-55.68003779057252, 86.20176494269847],
          [-61.45601993315672, 85.89017913245713],
          [-66.37532859434766, 85.54298702755824],
          [-70.55724119088521, 85.16790348854887],
          [-74.12022112082042, 84.77097678044598],
          [-71.97110864705208, 84.61841509935437],
          [-69.94331397518876, 84.45873464719025],
          [-68.0315123231705, 84.29253849885926],
          [-66.22993488762883, 84.12038499165931],
          [-64.5325844049517, 83.94278809292268],
          [-62.93340319357807, 83.76021880654855],
          [-61.42639995777989, 83.57310727610472],
          [-60.00574206724918, 83.38184531482337],
          [-58.665819773133734, 83.18678915779185],
          [-57.40128818663171, 82.98826228650147],
          [-53.951992624649165, 83.27843524136415],
          [-50.20571088005186, 83.54224084412589],
          [-46.15863801687481, 83.77628363534642],
          [-41.818277399785174, 83.97705623949825],
          [-37.20658593714978, 84.14110603045513],
          [-32.36219263801153, 84.2652552572159],
          [-27.340749255999818, 84.3468555174671],
          [-22.212645835564576, 84.38403943161795],
          [-17.05792785558349, 84.37592038404522],
          [-11.959143304085023, 84.32269393312409],
          [-11.56347384314647, 84.5702079431649],
          [-11.129970887643905, 84.81748727101969],
          [-10.652993182505446, 85.06448689529408],
          [-10.12573285508205, 85.31115283779752],
          [-9.539901649072773, 85.55741971247636],
          [-8.885311834454305, 85.80320743194677],
          [-8.149308950579606, 86.04841671801508],
          [-7.315992915614546, 86.29292288494149],
          [-6.365131918099119, 86.53656708154573],
          [-5.270622665103448, 86.77914371855618],
        ],
      ],
    },
  });

  expect(
    geojsonFromCornerCoordinates(
      [223069.075613658875227, -268407.860357680357993],
      [-275846.995845806901343, -495187.89283925422933],
      [335595.338145552086644, -515965.637927847041283],
      [-163320.733313913689926, -742745.670409420854412],
      "epsg:3411"
    )
  ).toEqual({
    type: "Feature",
    bbox: [
      -74.12022112082042,
      82.98826228650147,
      -5.270622665103448,
      86.88878705473334,
    ],
    properties: {},
    geometry: {
      type: "Polygon",
      coordinates: [
        [
          [-5.270622665103448, 86.77914371855618],
          [-14.250061369548213, 86.87412426312318],
          [-23.548864966957215, 86.88878705473334],
          [-32.693812151359616, 86.82201802001164],
          [-41.25560995422688, 86.67873416307306],
          [-48.9538596657912, 86.46825557920494],
          [-55.68003779057252, 86.20176494269847],
          [-61.45601993315672, 85.89017913245713],
          [-66.37532859434766, 85.54298702755824],
          [-70.55724119088521, 85.16790348854887],
          [-74.12022112082042, 84.77097678044598],
          [-71.97110864705208, 84.61841509935437],
          [-69.94331397518876, 84.45873464719025],
          [-68.0315123231705, 84.29253849885926],
          [-66.22993488762883, 84.12038499165931],
          [-64.5325844049517, 83.94278809292268],
          [-62.93340319357807, 83.76021880654855],
          [-61.42639995777989, 83.57310727610472],
          [-60.00574206724918, 83.38184531482337],
          [-58.665819773133734, 83.18678915779185],
          [-57.40128818663171, 82.98826228650147],
          [-53.951992624649165, 83.27843524136415],
          [-50.20571088005186, 83.54224084412589],
          [-46.15863801687481, 83.77628363534642],
          [-41.818277399785174, 83.97705623949825],
          [-37.20658593714978, 84.14110603045513],
          [-32.36219263801153, 84.2652552572159],
          [-27.340749255999818, 84.3468555174671],
          [-22.212645835564576, 84.38403943161795],
          [-17.05792785558349, 84.37592038404522],
          [-11.959143304085023, 84.32269393312409],
          [-11.56347384314647, 84.5702079431649],
          [-11.129970887643905, 84.81748727101969],
          [-10.652993182505446, 85.06448689529408],
          [-10.12573285508205, 85.31115283779752],
          [-9.539901649072773, 85.55741971247636],
          [-8.885311834454305, 85.80320743194677],
          [-8.149308950579606, 86.04841671801508],
          [-7.315992915614546, 86.29292288494149],
          [-6.365131918099119, 86.53656708154573],
          [-5.270622665103448, 86.77914371855618],
        ],
      ],
    },
  });

  expect(
    geojsonFromCornerCoordinates(
      [508800.0, 7247400.0],
      [508800.0, 7001100.0],
      [753000.0, 7247400.0],
      [753000.0, 7001100.0],
      crsEpsg32660,
      {
        partition: 1,
      }
    )
  ).toEqual({
    type: "Feature",
    bbox: [
      177.17456390562776,
      63.05068519969726,
      -177.57860702499977,
      65.34932256544839,
    ],
    properties: {},
    geometry: {
      type: "MultiPolygon",
      coordinates: [
        [
          [
            [180, 65.31807448056006],
            [179.81058927281356, 65.323257946911],
            [177.18908505580518, 65.34932256544839],
            [177.18150083071316, 64.24429821916638],
            [177.17456390562776, 63.13910500179646],
            [179.59505058865196, 63.11547654369982],
            [180, 63.104599649017885],
            [180, 65.31807448056006],
          ],
        ],
        [
          [
            [-180, 63.104599649017885],
            [-177.99275205341496, 63.05068519969726],
            [-177.79484203871405, 64.15151244109893],
            [-177.57860702499977, 65.25180997065199],
            [-180, 65.31807448056006],
            [-180, 63.104599649017885],
          ],
        ],
      ],
    },
  });
});

it("invalid", () => {
  expect(() => {
    transformRing(
      [
        [0, 0],
        [10, 10],
      ],
      crsEpsg4326
    );
  }).toThrowError(InvalidLinearRingError);

  expect(() => {
    transformRing(
      [
        [-4525934.615208394825459, 8626327.724166244268417],
        [7103066.913057595491409, 6594075.02990616671741],
        [3037818.062780980952084, -16668182.280009945854545],
        [-8591183.465485010296106, -14635929.585749868303537],
        [-4525934.615208394825459, 8626327.724166244268417],
      ],
      "+proj=aeqd +lat_0=35.7 +lon_0=139.8 +x_0=0 +y_0=0 +ellps=WGS84 +units=m +no_defs"
    );
  }).toThrowError(EnclosingBothPolesError);

  expect(() => {
    transformBbox([508800, 7001100, 753000, 7247400, 1000], crsEpsg32660);
  }).toThrowError(InvalidBoundsError);

  expect(() => {
    transformBbox([508800, 7001100, -753000, 7247400], crsEpsg32660);
  }).toThrowError(NotAllowedWarpBoundsError);

  expect(() => {
    transformBbox([508800, 7001100, 10, -753000, 7247400, 100], crsEpsg32660);
  }).toThrowError(NotAllowedWarpBoundsError);

  expect(() => {
    geojsonFromLinearRing(
      [
        [508800.0, 7247400.0],
        [508800.0, 7001100.0],
        [753000.0, 7001100.0],
        [753000.0, 7247400.0],
      ],
      crsEpsg32660
    );
  }).toThrowError(InvalidLinearRingError);

  expect(() => {
    geojsonFromCornerCoordinates(
      [508800.0, 7247400.0],
      [508800.0, 7001100.0],
      [-753000.0, 7247400.0],
      [-753000.0, 7001100.0],
      crsEpsg32660
    );
  }).toThrowError(NotAllowedCwLinearRingError);

  expect(() => {
    _transformEnclosingPoleRing(
      [
        [223069.075613658875227, -268407.860357680357993],
        [-275846.995845806901343, -495187.89283925422933],
        [-163320.733313913689926, -742745.670409420854412],
        [335595.338145552086644, -515965.637927847041283],
        [223069.075613658875227, -268407.860357680357993],
      ],
      crsEpsg3411,
      {
        partition: 0,
      }
    );
  }).toThrowError(InvalidLinearRingEnclosingPoleError);

  expect(() => {
    _transformEnclosingPoleRing(
      [
        [223069.075613658875227, -268407.860357680357993],
        [-275846.995845806901343, -495187.89283925422933],
        [-163320.733313913689926, -742745.670409420854412],
        [335595.338145552086644, -515965.637927847041283],
        [223069.075613658875227, -268407.860357680357993],
      ],
      crsEpsg3411,
      {
        partition: 0,
      }
    );
  }).toThrowError(InvalidLinearRingEnclosingPoleError);

  expect(() => {
    _transformEnclosingPoleRing(
      [
        [-1246746.554110115393996, 698551.317503924481571],
        [-730678.815933575853705, 122937.301845476031303],
        [-75669.763632582500577, 738248.835825197398663],
        [142666.587134415283799, 559610.003379471600056],
        [-512342.465166578069329, -115247.808082157745957],
        [996163.231041770428419, -1564207.226808596402407],
        [2187088.780679939314723, -452676.713812971487641],
        [-75669.763632582500577, 1770384.312178276944906],
        [-1246746.554110115393996, 698551.317503924481571],
      ],
      crsEpsg3411,
      {
        partition: 5,
      }
    );
  }).toThrowError(InvalidLinearRingEnclosingPoleError);
});
